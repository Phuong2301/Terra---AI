import 'dart:io';
import 'package:flutter/services.dart';
import 'package:path_provider/path_provider.dart';
import 'package:pdf/pdf.dart';
import 'package:pdf/widgets.dart' as pw;
import 'package:printing/printing.dart';
import 'package:open_filex/open_filex.dart';

import '../risk_scoring.dart';

class PdfExportService {
  PdfExportService._();

  static const String _logoAssetPath = 'assets/branding/logo.png';
  static const String _brandName = 'Mekong Credit Assessment';

  static PdfColor _scoreColor(int score) {
    if (score >= 75) return const PdfColor.fromInt(0xFF16A34A); // green
    if (score >= 50) return const PdfColor.fromInt(0xFFF59E0B); // yellow
    return const PdfColor.fromInt(0xFFDC2626); // red
  }
  static PdfColor _tint(PdfColor c, {double strength = 0.12}) {
    final s = strength.clamp(0.0, 1.0);
    return PdfColor(
      1 - (1 - c.red) * s,
      1 - (1 - c.green) * s,
      1 - (1 - c.blue) * s,
    );
  }

  static Future<Uint8List?> _loadLogoBytes() async {
    try {
      final data = await rootBundle.load(_logoAssetPath);
      return data.buffer.asUint8List();
    } catch (_) {
      return null; // logo optional
    }
  }

  static Future<Uint8List> buildPdfBytes({
    required Map<String, dynamic> payload,
    required RiskScoreResult result,
  }) async {
    final logoBytes = await _loadLogoBytes();
    final logo = logoBytes != null ? pw.MemoryImage(logoBytes) : null;

    final name = (payload['fullName'] ?? 'Farmer').toString();
    final phone = (payload['phone'] ?? '').toString();
    final address = (payload['address'] ?? '').toString();
    final province = (payload['province'] ?? '').toString();
    final district = (payload['district'] ?? '').toString();
    final crop = (payload['mainCrop'] ?? '').toString();
    final farmSizeHa = payload['farmSizeHa'];

    final createdAt = DateTime.tryParse((payload['createdAt'] ?? '').toString()) ?? DateTime.now();
    final createdText =
        '${createdAt.year}-${createdAt.month.toString().padLeft(2, '0')}-${createdAt.day.toString().padLeft(2, '0')} '
        '${createdAt.hour.toString().padLeft(2, '0')}:${createdAt.minute.toString().padLeft(2, '0')}';

    final score = result.finalScore;
    final scoreColor = _scoreColor(score);

    final doc = pw.Document();

    doc.addPage(
      pw.MultiPage(
        pageFormat: PdfPageFormat.a4,
        margin: const pw.EdgeInsets.fromLTRB(28, 30, 28, 30),
        build: (context) => [
          _header(logo: logo, createdText: createdText),
          pw.SizedBox(height: 18),

          pw.Text(
            'Credit Assessment Report',
            style: pw.TextStyle(fontSize: 20, fontWeight: pw.FontWeight.bold),
          ),
          pw.SizedBox(height: 8),
          pw.Text(
            'Shareable, local-first report generated by AI scoring.',
            style: pw.TextStyle(color: PdfColors.grey700, fontSize: 10),
          ),

          pw.SizedBox(height: 18),

          _sectionTitle('Farmer Information'),
          _kvGrid([
            _kv('Name', name),
            _kv('Phone', phone.isEmpty ? '—' : phone),
            _kv('Address', address.isEmpty ? '—' : address),
            _kv('Province / District', _join(province, district)),
            _kv('Main crop', crop.isEmpty ? '—' : crop),
            _kv('Farm size (ha)', farmSizeHa == null ? '—' : farmSizeHa.toString()),
          ]),

          pw.SizedBox(height: 14),

          _sectionTitle('Risk Score'),
          _scoreBlock(
            score: score,
            category: result.category,
            recommendation: result.recommendation,
            color: scoreColor,
            base: result.baseScore,
            aiAdj: result.aiAdjustment,
            fpoBoost: result.fpoBoost,
          ),

          pw.SizedBox(height: 14),

          _sectionTitle('Recommended Loan Terms'),
          _termsTable(result.termsWith),

          pw.SizedBox(height: 14),

          _sectionTitle('AI Reasoning'),
          pw.Container(
            padding: const pw.EdgeInsets.all(12),
            decoration: pw.BoxDecoration(
              border: pw.Border.all(color: PdfColors.grey300),
              borderRadius: pw.BorderRadius.circular(10),
              color: PdfColors.grey50,
            ),
            child: pw.Text(
              result.reasoning,
              style: pw.TextStyle(fontSize: 11, color: PdfColors.grey800, lineSpacing: 4),
            ),
          ),

          pw.SizedBox(height: 18),
          _footer(),
        ],
      ),
    );

    return doc.save();
  }

  static Future<File> saveToDevice({
    required Uint8List bytes,
    required String fileName,
  }) async {
    final dir = await getApplicationDocumentsDirectory();
    final file = File('${dir.path}/$fileName');
    await file.writeAsBytes(bytes, flush: true);
    return file;
  }

  /// Share native sheet (Android/iOS)
  static Future<void> sharePdf({
    required Uint8List bytes,
    required String fileName,
    String? text,
  }) async {
    // Option A: share bytes directly (printing)
    await Printing.sharePdf(bytes: bytes, filename: fileName);

    // Option B: share as file (share_plus) – dùng khi bạn muốn kèm message
    // final file = await saveToDevice(bytes: bytes, fileName: fileName);
    // await Share.shareXFiles([XFile(file.path)], text: text ?? '');
  }

  static Future<void> openFile(File file) async {
    await OpenFilex.open(file.path);
  }

  static pw.Widget _header({pw.ImageProvider? logo, required String createdText}) {
    return pw.Container(
      padding: const pw.EdgeInsets.only(bottom: 10),
      decoration: const pw.BoxDecoration(
        border: pw.Border(bottom: pw.BorderSide(color: PdfColors.grey300, width: 1)),
      ),
      child: pw.Row(
        crossAxisAlignment: pw.CrossAxisAlignment.center,
        children: [
          if (logo != null)
            pw.Container(
              width: 34,
              height: 34,
              margin: const pw.EdgeInsets.only(right: 10),
              child: pw.Image(logo, fit: pw.BoxFit.contain),
            ),
          pw.Expanded(
            child: pw.Column(
              crossAxisAlignment: pw.CrossAxisAlignment.start,
              children: [
                pw.Text(
                  _brandName,
                  style: pw.TextStyle(fontSize: 14, fontWeight: pw.FontWeight.bold),
                ),
                pw.SizedBox(height: 2),
                pw.Text(
                  'Generated: $createdText',
                  style: pw.TextStyle(fontSize: 9, color: PdfColors.grey700),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  static pw.Widget _sectionTitle(String text) {
    return pw.Padding(
      padding: const pw.EdgeInsets.only(bottom: 8),
      child: pw.Text(
        text,
        style: pw.TextStyle(fontSize: 12, fontWeight: pw.FontWeight.bold),
      ),
    );
  }

  static pw.Widget _kvGrid(List<pw.Widget> items) {
    // 2 columns
    final rows = <pw.Widget>[];
    for (int i = 0; i < items.length; i += 2) {
      rows.add(
        pw.Row(
          children: [
            pw.Expanded(child: items[i]),
            pw.SizedBox(width: 12),
            pw.Expanded(child: i + 1 < items.length ? items[i + 1] : pw.SizedBox()),
          ],
        ),
      );
      rows.add(pw.SizedBox(height: 8));
    }

    return pw.Container(
      padding: const pw.EdgeInsets.all(12),
      decoration: pw.BoxDecoration(
        border: pw.Border.all(color: PdfColors.grey300),
        borderRadius: pw.BorderRadius.circular(10),
      ),
      child: pw.Column(children: rows),
    );
  }

  static pw.Widget _kv(String k, String v) {
    return pw.Column(
      crossAxisAlignment: pw.CrossAxisAlignment.start,
      children: [
        pw.Text(k, style: pw.TextStyle(fontSize: 9, color: PdfColors.grey700)),
        pw.SizedBox(height: 2),
        pw.Text(v, style: pw.TextStyle(fontSize: 11, fontWeight: pw.FontWeight.bold)),
      ],
    );
  }

  static String _join(String a, String b) {
    final aa = a.trim();
    final bb = b.trim();
    if (aa.isEmpty && bb.isEmpty) return '—';
    if (aa.isEmpty) return bb;
    if (bb.isEmpty) return aa;
    return '$aa / $bb';
  }

  static pw.Widget _scoreBlock({
    required int score,
    required String category,
    required String recommendation,
    required PdfColor color,
    required int base,
    required int aiAdj,
    required int fpoBoost,
  }) {
    String fmtAdj(int v) => '${v >= 0 ? '+' : ''}$v';

    return pw.Container(
      padding: const pw.EdgeInsets.all(12),
      decoration: pw.BoxDecoration(
        border: pw.Border.all(color: PdfColors.grey300),
        borderRadius: pw.BorderRadius.circular(10),
      ),
      child: pw.Row(
        children: [
          pw.Container(
            width: 84,
            height: 84,
            decoration: pw.BoxDecoration(
              color: _tint(color, strength: 0.12),
              borderRadius: pw.BorderRadius.circular(14),
              border: pw.Border.all(color: color, width: 2),
            ),
            child: pw.Center(
              child: pw.Column(
                mainAxisSize: pw.MainAxisSize.min,
                children: [
                  pw.Text(
                    '$score',
                    style: pw.TextStyle(fontSize: 26, fontWeight: pw.FontWeight.bold, color: color),
                  ),
                  pw.Text('Score', style: pw.TextStyle(fontSize: 9, color: PdfColors.grey700)),
                ],
              ),
            ),
          ),
          pw.SizedBox(width: 12),
          pw.Expanded(
            child: pw.Column(
              crossAxisAlignment: pw.CrossAxisAlignment.start,
              children: [
                pw.Text(
                  category,
                  style: pw.TextStyle(fontSize: 14, fontWeight: pw.FontWeight.bold, color: color),
                ),
                pw.SizedBox(height: 4),
                pw.Text(
                  recommendation,
                  style: pw.TextStyle(fontSize: 10, color: PdfColors.grey800),
                ),
                pw.SizedBox(height: 8),
                pw.Row(
                  mainAxisAlignment: pw.MainAxisAlignment.spaceBetween,
                  children: [
                    pw.Text('Base: $base', style: pw.TextStyle(fontSize: 9, color: PdfColors.grey700)),
                    pw.Text('AI: ${fmtAdj(aiAdj)}', style: pw.TextStyle(fontSize: 9, color: PdfColors.grey700)),
                    pw.Text('FPO: ${fpoBoost > 0 ? '+$fpoBoost' : '0'}',
                        style: pw.TextStyle(fontSize: 9, color: PdfColors.grey700)),
                  ],
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  static pw.Widget _termsTable(LoanTerms terms) {
    pw.TableRow row(String k, String v) => pw.TableRow(
          children: [
            pw.Padding(
              padding: const pw.EdgeInsets.symmetric(vertical: 8, horizontal: 8),
              child: pw.Text(k, style: pw.TextStyle(fontSize: 10, color: PdfColors.grey700)),
            ),
            pw.Padding(
              padding: const pw.EdgeInsets.symmetric(vertical: 8, horizontal: 8),
              child: pw.Text(v, style: pw.TextStyle(fontSize: 11, fontWeight: pw.FontWeight.bold)),
            ),
          ],
        );

    return pw.Container(
      decoration: pw.BoxDecoration(
        border: pw.Border.all(color: PdfColors.grey300),
        borderRadius: pw.BorderRadius.circular(10),
      ),
      child: pw.Table(
        columnWidths: const {
          0: pw.FlexColumnWidth(2),
          1: pw.FlexColumnWidth(3),
        },
        border: pw.TableBorder(
          horizontalInside: pw.BorderSide(color: PdfColors.grey200),
        ),
        children: [
          row('Max amount', '\$${terms.maxAmount.toStringAsFixed(0)}'),
          row('Interest', '${terms.interestRate.toStringAsFixed(1)}% / yr'),
          row('Tenure', '${terms.tenureMonths} months'),
          row('Repayment', terms.repayment),
        ],
      ),
    );
  }

  static pw.Widget _footer() {
    return pw.Column(
      crossAxisAlignment: pw.CrossAxisAlignment.start,
      children: [
        pw.Divider(color: PdfColors.grey300),
        pw.SizedBox(height: 6),
        pw.Text(
          'Note: This report is generated for demo/MVP purposes and should be validated by a credit officer.',
          style: pw.TextStyle(fontSize: 9, color: PdfColors.grey700),
        ),
      ],
    );
  }
}
